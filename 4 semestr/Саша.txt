--19.Выбрать номера транспортных средств, которые оставались в зоне
--парковки N (конкретное значение подставьте сами) на ночь.
SELECT ТС.Номер
FROM [Транспортное средство] ТС JOIN [Въезд Выезд] ВВ ON ВВ.ID_ТС = ТС.ID_ТС JOIN [Зона парковки] ЗП JOIN ЗП.ID_ЗП = ВВ.ID_ЗП
WHERE HOUR(ВВ.Дата_Время_IN) BETWEEN 0 AND 6 AND ЗП.ID_ЗП = 1;

--20.Выбрать название и код зоны парковки, количество парковавшихся
--транспортных средств.
SELECT ЗП.ID_ЗП, ЗП.Название, COUNT(ТС.ID_ТС)
FROM [Транспортное средство] ТС JOIN [Въезд Выезд] ВВ ON ВВ.ID_ТС = ТС.ID_ТС RIGHT JOIN [Зона парковки] ЗП JOIN ЗП.ID_ЗП = ВВ.ID_ЗП
GROUP BY ЗП.ID_ЗП, ЗП.Название;

--21.Выбрать все данные о зонах парковки и количество парковавшихся
--автомобилей в каждой зоне в текущем году. В результат включить только
--парковки вместимостью больше N (значение подставьте сами).
SELECT ЗП.ID_ЗП, ЗП.Название, COUNT(ТС.ID_ТС)
FROM [Транспортное средство] ТС JOIN [Въезд Выезд] ВВ ON ВВ.ID_ТС = ТС.ID_ТС RIGHT JOIN [Зона парковки] ЗП JOIN ЗП.ID_ЗП = ВВ.ID_ЗП
WHERE YEAR(ВВ.Дата_Время_IN) = YEAR(GETDATE()) OR YEAR(ВВ.Дата_Время_OUT) = YEAR(GETDATE()) AND ЗП.Вместимость > 50
GROUP BY ЗП.ID_ЗП, ЗП.Название;

--22.Выбрать номер транспортного средства, которое въезжало на парковку
--более трех раз.
SELECT ТС.Номер
FROM [Транспортное средство] ТС JOIN [Въезд Выезд] ВВ ON ВВ.ID_ТС = ТС.ID_ТС
GROUP BY ТС.Номер, Дата_Время_IN
HAVING COUNT(ВВ.Дата_Время_IN) > 3;

--23.Выбрать номер транспортного средства, которое въезжало на парковку
--несколько раз за один день.
SELECT ТС.Номер
FROM [Транспортное средство] ТС JOIN [Въезд Выезд] ВВ ON ВВ.ID_ТС = ТС.ID_ТС
GROUP BY ТС.Номер, Дата_Время_IN
HAVING COUNT(ВВ.Дата_Время_IN) > 1;

--24.Выбрать номер транспортного средства, которое въезжало на парковку
--несколько раз за один день, но всегда в одну и ту же зону парковки.
--Результат отсортировать по убыванию.
SELECT ТС.Номер, COUNT(ВВ.Дата_Время_IN)
FROM [Транспортное средство] ТС JOIN [Въезд Выезд] ВВ ON ВВ.ID_ТС = ТС.ID_ТС JOIN [Зона парковки] ЗП JOIN ЗП.ID_ЗП = ВВ.ID_ЗП
GROUP BY ТС.Номер, Дата_Время_IN, ЗП.ID_ЗП
HAVING COUNT(ВВ.Дата_Время_IN) > 1
ORDER BY 2 DESC;

--25.Выбрать все данные типа, транспортные средства которого въезжали на
--парковку в текущем месяце более трех раз.
SELECT ТТС.*
FROM [Тип ТС] ТТС JOIN [Транспортное средство] ТС ON ТС.ID_ТТС = ТТС.ID_ТТС JOIN [Въезд Выезд] ВВ ON ВВ.ID_ТС = ТС.ID_ТС
WHERE MONTH(ВВ.Дата_Время_IN) = MONTH(GETDATE())
GROUP BY ТТС.*
HAVING COUNT(ВВ.Дата_Время_IN) > 3;

--26.Выбрать зону парковки вместимостью больше N и дату(ы) текущего
--месяца, когда в зоне парковки побывало ТС в два раза больше, чем
--вместимость парковочной зоны. Результат отсортировать по дате.
SELECT ЗП.ID_ЗП, Дата_Время_IN + ' - ' + Дата_Время_OUT
FROM [Зона парковки] ЗП JOIN [Въезд Выезд] ВВ ON ЗП.ID_ЗП = ВВ.ID_ЗП JOIN [Транспортное средство] ТС ON ТС.ID_ТС = ВВ.ID_ТС
WHERE Вместимость > 500 AND (MONTH(Дата_Время_IN) = MONTH(GETDATE() OR MONTH(Дата_Время_OUT) = MONTH(GETDATE());
GROUP BY ЗП.ID_ЗП, Дата_Время_IN + ' - ' + Дата_Время_OUT, ТС.ID_ТС
HAVING COUNT(ТС.ID_ТС) >= 2 * ЗП.Вмсетимость
ORDER BY Дата_Время_IN, Дата_Время_OUT;

--27.Выбрать все типы транспортных средств, и если есть тариф на
--соответствующий тип, то выбрать стоимость и дату вступления в силу.
SELECT ТТС.ID_ТТС, CASE
                       WHEN ID_Тариф IS NOT NULL
                       THEN Стоимость_часа, Дата_вступления_в_силу
                   END
FROM [Тип ТС] ТТС LEFT JOIN Тарифы Т ON Т.ID_ТТС = ТТС.ID_ТТС;

--28.Выбрать все номера транспортных средств, и если транспортное средство
--парковалось в текущем месяце, то дату и время въезда и выезда.
SELECT ТС.Номер, CASE
                     WHEN MONTH(Дата_Время_IN) = MONTH(GETDATE())
                     THEN Дата_Время_IN, Дата_Время_OUT
                 END
FROM [Транспортное средство] ТС LEFT JOIN [Въезд Выезд] ВВ ON ВВ.ID_ТС = ТС.ID_ТС;

--29.Выбрать пары названий типов транспортных средств, которые имеют одинаковые тарифы.
SELECT
FROM [Тип ТС] ТС1 JOIN Тарифы Т1 ON ТС1.ID_ТТС = Т1.ID_ТТС JOIN [Тип ТС] ТС2 JOIN Тарифы Т2 ON ТС2.ID_ТТС = Т2.ID_ТТС
WHERE ТС1.ID_ТТС <> ТС2.ID_ТТС AND Т1.ID_Тариф = Т2.ID_Тариф;

--30.Выбрать для каждой зоны парковки все виды транспортных средств. Результат отсортировать по названию вида и коду зоны парковки.
SELECT З_П.ID_ЗП, [Тип ТС].ID_ТТС, 
FROM [Зона парковки] З_П LEFT JOIN [Въезд Выезд] В_В ON В_В.ID_ЗП = З_П.ID_ЗП LEFT JOIN [Транспортное средство] ТС ON ТС.ID_ТС = В_В.ID_ТС FULL JOIN [Тип ТС] ON [Тип ТС].ID_ТТС = ТС.ID_ТТС
ORDER BY З_П.Назвние, З_П.Код;

----32.Выбрать зоны парковки, названия которых совпадают с названием типа ТС.
SELECT З_П.ID_ЗП
FROM [Тип ТС] JOIN Тарифы Т ON [Тип ТС].ID_ТТС = Т.ID_ТТС JOIN [Зона парковки] З_П ON З_П.ID_ЗП = Т.ID_ЗП AND [Тип ТС].Название = З_П.Название;

--33.Выбрать пары номеров и названий типов ТС, которые парковались в один
--и тот же день с разницей в 5 минут в одной и той же зоне парковки.
SELECT ТС1.Номер, Тип1.Название
FROM Зона парковки] З_П1 JOIN [Въезд Выезд] ВВ1 ON З_П1.ID_ЗП = ВВ1.ID_ЗП JOIN [Транспортное средство] ТС1 ON ТС1.ID_ТС = ВВ1.ID_ТС
     JOIN [Зона парковки] З_П2 ON З_П2.ID_ЗП = З_П1.ID_ЗП JOIN [Въезд Выезд] ВВ2 ON З_П2.ID_ЗП = ВВ2.ID_ЗП 
     JOIN [Транспортное средство] ТС2 ON ТС2.ID_ТС = ВВ2.ID_ТС AND ТС2.ID_ТС <> ТС1.ID_ТС
     JOIN [Тип ТС] Тип1 ON Тип1.ID_ТТС = ТС1.ID_ТТС JOIN [Тип ТС] Тип2 ON Тип2.ID_ТТС = ТС2.ID_ТТС
WHERE ABS(MINUTE(ВВ1.[Дата_Время_IN]) - MINUTE(ВВ2.[Дата_Время_IN])) = 5 AND З_П1.ID_ЗП = З_П2.ID_ЗП 
	AND YEAR(ВВ1.[Дата_Время_IN])) = YEAR(ВВ2.[Дата_Время_IN])) AND MONTH(ВВ1.[Дата_Время_IN])) = MONTH(ВВ2.[Дата_Время_IN])) AND DAY(ВВ1.[Дата_Время_IN])) = DAY(ВВ2.[Дата_Время_IN]));

--34.Выбрать номера легковых транспортных средств, которые въезжали на
--парковку 24 дня за один месяц.
SELECT ТС.Номер
FROM [Транспортное средство] ТС JOIN [Въезд Выезд] ВВ ON ВВ.ID_ТС = ТС.ID_ТС JOIN [Тип ТС] ON [Тип ТС].ID_ТТС = ТС.ID_ТТС
WHERE [Тип ТС].Название = 'Легковой автомобиль'
GROUP BY ТС.Номер, MONTH(ВВ.Дата_Время_IN)
HAVING COUNT(ВВ.ID_ВВ) = 24;

--35.Выбрать все данные зон парковки, на которых одновременно парковалось
--два различных вида транспортных средства.
SELECT З_П.*
FROM [Зона парковки] З_П1 JOIN [Въезд Выезд] ВВ1 ON З_П1.ID_ЗП = ВВ1.ID_ЗП JOIN [Транспортное средство] ТС1 ON ТС1.ID_ТС = ВВ1.ID_ТС
     JOIN [Зона парковки] З_П2 ON З_П2.ID_ЗП = З_П1.ID_ЗП JOIN [Въезд Выезд] ВВ2 ON З_П2.ID_ЗП = ВВ2.ID_ЗП 
     JOIN [Транспортное средство] ТС2 ON ТС2.ID_ТС = ВВ2.ID_ТС AND ТС2.ID_ТС <> ТС1.ID_ТС
WHERE (ВВ1.Дата_Время_IN > ВВ2.Дата_Время_IN AND ВВ2.Дата_Время_OUT > ВВ1.Дата_Время_IN)
	OR (ВВ2.Дата_Время_IN > ВВ1.Дата_Время_IN AND ВВ1.Дата_Время_OUT > ВВ2.Дата_Время_IN)
GROUP BY ТС1.ID_ТС, З_П.*
HAVING COUNT(З_П.ID_ЗП) > 1;

--36.Выбрать зону парковки с максимальной вместимостью.
SELECT ID_ЗП, Название
FROM [Зона парковки]
WHERE Вместимость = (
			SELECT MAX(Вместимость)
			FROM [Зона парковки] 
		    );


--37.Выбрать зоны парковки с максимальной и минимальной вместимостью.
SELECT ID_ЗП, Название
FROM [Зона парковки]
WHERE Вместимость = (
			SELECT MAX(Вместимость)
			FROM [Зона парковки] 
		    )
	OR
	Вместимость = (
			SELECT MAX(Вместимость)
			FROM [Зона парковки] 
		    );

--38.Выбрать типы транспортных средств для которых не указан тариф.
SELECT ID_ТТС
FROM [Тип ТС]
WHERE NOT EXISTS(
			SELECT 1
			FROM Тарифы
			WHERE [Тип ТС].ID_ТТС = ID_ТТС
		);

--40.Для каждого типа транспортного средства выбрать тариф действительный
--на сегодняшний день.
SELECT ТС.ID_ТС, Т.ID_Тариф
FROM [Транспортное средство] ТС LEFT JOIN [Тип ТС] ON ТС.ID_ТТС = [Тип ТС].ID_ТТС LEFT JOIN Тарифы Т ON [Тип ТС].ID_ТТС = Т.ID_ТТС
GROUP BY ТС.ID_ТС, Т.ID_Тариф
HAVING Т.[Дата вступления в силу] = MAX(Т.[Дата вступления в силу]);